(function(e){e.fn.formset=function(t){t.prefix=t.prefix||e(this).data("prefix");var n=e.extend({},e.fn.formset.defaults,t),r=n.extraClasses.join(" "),i=e("#id_"+n.prefix+"-TOTAL_FORMS"),s=e("#id_"+n.prefix+"-MAX_NUM_FORMS"),o=Math.max(1,n.minNum||parseInt(e("#id_"+n.prefix+"-INITIAL_FORMS").val())),u="input,select,textarea,label,div",a=e(this),f=function(e,t){if(n.extraClasses){e.removeClass(r);e.addClass(n.extraClasses[t%n.extraClasses.length])}},l=function(e,t,n){var r=new RegExp(t+"-(\\d+|__prefix__)-"),i=t+"-"+n+"-";if(e.attr("for"))e.attr("for",e.attr("for").replace(r,i));if(e.attr("id"))e.attr("id",e.attr("id").replace(r,i));if(e.attr("name"))e.attr("name",e.attr("name").replace(r,i))},c=function(e){return e.find(u).length>0},h=function(){return s.length==0||s.val()==""||s.val()-i.val()>0},p=function(t,r){if(r<o){return}if(t.is("TR")){t.children(":last").append('<a class="'+n.deleteCssClass+'" href="javascript:void(0)">'+n.deleteText+"</a>")}else if(t.is("UL")||t.is("OL")){t.append('<li><a class="'+n.deleteCssClass+'" href="javascript:void(0)">'+n.deleteText+"</a></li>")}else if(t.find("a."+n.deleteCssClass).length==0){t.append('<a class="'+n.deleteCssClass+'" href="javascript:void(0)">'+n.deleteText+"</a>")}t.find("a."+n.deleteCssClass).click(function(){var t=e(this).parents("."+n.formCssClass),r=t.find('input:hidden[id $= "-DELETE"]'),s=t.siblings("a."+n.addCssClass+", ."+n.formCssClass+"-add"),o;if(r.length){r.val("on");t.hide();o=e("."+n.formCssClass).not(":hidden")}else{t.remove();o=e("."+n.formCssClass).not(".formset-custom-template");i.val(o.length)}for(var a=0,c=o.length;a<c;a++){f(o.eq(a),a);if(!r.length){o.eq(a).find(u).each(function(){l(e(this),n.prefix,a)})}}if(s.is(":hidden")&&h())s.show();if(n.removed)n.removed(t);return false})};a.each(function(t){var r=e(this),i=r.find('input:checkbox[id $= "-DELETE"]');if(i.length){if(i.is(":checked")){i.before('<input type="hidden" name="'+i.attr("name")+'" id="'+i.attr("id")+'" value="on" />');r.hide()}else{i.before('<input type="hidden" name="'+i.attr("name")+'" id="'+i.attr("id")+'" />')}e('label[for="'+i.attr("id")+'"]').hide();i.remove()}if(c(r)){r.addClass(n.formCssClass);if(r.is(":visible")){p(r,t);f(r,t)}}});if(a.length){var d=!h(),v,m;if(n.formTemplate){m=n.formTemplate instanceof e?n.formTemplate:e(n.formTemplate);m.removeAttr("id").addClass(n.formCssClass+" formset-custom-template");m.find(u).each(function(){l(e(this),n.prefix,"__prefix__")})}else{m=e("."+n.formCssClass+":last").clone(true).removeAttr("id");m.find('input:hidden[id $= "-DELETE"]').remove();m.find(u).not(n.keepFieldValues).each(function(){var t=e(this);if(t.is("input:checkbox")||t.is("input:radio")){t.attr("checked",false)}else{t.val("")}})}n.formTemplate=m;if(a.attr("tagName")=="TR"){var g=a.eq(0).children().length,y=e('<tr><td colspan="'+g+'"><a class="'+n.addCssClass+'" href="javascript:void(0)">'+n.addText+"</a></tr>").addClass(n.formCssClass+"-add");a.parent().append(y);if(d)y.hide();v=y.find("a")}else{e("a."+n.addCssClass).remove();a.filter(":last").after('<a class="'+n.addCssClass+'" href="javascript:void(0)">'+n.addText+"</a>");v=a.filter(":last").next();if(d)v.hide()}v.click(function(){var t=parseInt(i.val()),r=n.formTemplate.clone(true).removeClass("formset-custom-template"),s=e(e(this).parents("tr."+n.formCssClass+"-add").get(0)||this);f(r,t);r.insertBefore(s).show();r.find(u).each(function(){l(e(this),n.prefix,t)});i.val(t+1);p(r,t+1);if(!h())s.hide();if(n.added)n.added(r);return false})}return a};e.fn.formset.defaults={prefix:null,minNum:null,formTemplate:null,addText:"add another",deleteText:"remove",addCssClass:"add-row",deleteCssClass:"delete-row",formCssClass:"dynamic-form",extraClasses:[],keepFieldValues:"",added:null,removed:null}})(jQuery)